services:
    flask-app:
        build:
            context: .
            dockerfile: dashboard/Dockerfile_dashboard
        ports:
            - 8080:5000
        volumes:
            - ./dashboard:/app
            - ./data:/data
        environment:
            - NAME=Flask-App
            - PYTHONPATH=/app
            # Database connection strings
            - POSTGRES_URL=postgresql://student:infomdss@db_dashboard:5432/knrb_dashboard
            - MONGODB_URL=mongodb://mongo:27017/knrb_dashboard
        working_dir: /app
        depends_on:
            db_dashboard:
                condition: service_healthy
            mongo:
                condition: service_healthy

    # PostgreSQL Database (legacy/backup)
    db_dashboard:
        image: postgres
        ports:
            - 5432:5432
        environment:
            - POSTGRES_USER=student
            - POSTGRES_PASSWORD=infomdss
            - POSTGRES_DB=knrb_dashboard
        volumes:
            - db_dashboard-data:/var/lib/postgresql/data/
        container_name: db_dashboard
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U student -d knrb_dashboard" ]
            interval: 3s
            timeout: 60s
            retries: 10
            start_period: 80s

    # MongoDB Database (primary)
    mongo:
        image: mongo:7
        ports:
            - 27017:27017
        environment:
            - MONGO_INITDB_DATABASE=knrb_dashboard
        volumes:
            - mongo-data:/data/db
            - ./mongo-init:/docker-entrypoint-initdb.d
        container_name: mongo_dashboard
        healthcheck:
            test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 40s

    # PostgreSQL Web Interface (for migration verification)
    adminer:
        image: adminer:4.8.1
        ports:
            - 8081:8080
        environment:
            - ADMINER_DEFAULT_SERVER=db_dashboard
            - ADMINER_DEFAULT_USER=student
            - ADMINER_DEFAULT_PASSWORD=infomdss
            - ADMINER_DEFAULT_DB=knrb_dashboard
        depends_on:
            db_dashboard:
                condition: service_healthy
        container_name: adminer

    # KNRB Scraper Service (run once or on-demand)
    # docker compose --profile scraper run --rm knrb-scraper
    knrb-scraper:
        build:
            context: .
            dockerfile: knrb_scraper/Dockerfile
        environment:
            # JSON output configuration
            - JSON_OUTPUT_DIR=/app/data/knrb_data
            # Optional proxy configuration
            - PROXY_URL=${PROXY_URL:-}
            # Scraper configuration
            - PYTHONUNBUFFERED=1
            - MAX_WORKERS=${MAX_WORKERS:-8}
        volumes:
            - ./knrb_scraper:/app
            - ./logs:/app/logs
            - ./data:/app/data
        profiles:
            - scraper
        container_name: knrb_scraper
        # Default command runs the JSON scraper
        # command: ["python", "knrb_scraper.py"]

        # Time Team Scraper Service (run once or on-demand)
        # docker compose --profile scraper run --rm time-team-scraper
    time-team-scraper:
        build:
            context: .
            dockerfile: time_team_scraper/Dockerfile
        environment:
            - JSON_OUTPUT_DIR=/app/data/time_team_data
            - PROXY_URL=${PROXY_URL:-}
            - PYTHONUNBUFFERED=1
            - MAX_WORKERS=${MAX_WORKERS:-8}
        volumes:
            - ./time_team_scraper:/app
            - ./logs:/app/logs
            - ./data:/app/data
        profiles:
            - scraper
        container_name: time_team_scraper
        # Default command runs the JSON scraper
        # command: ["python", "time_team_scraper.py"]

        # JSON Importer Service (run once or on-demand)
        # docker compose build json-importer
        # docker compose --profile importer run --rm json-importer
    json-importer:
        build:
            context: .
            dockerfile: json_importer/Dockerfile
        environment:
            # Database connection
            - DB_HOST=db_dashboard
            - DB_NAME=knrb_dashboard
            - DB_USER=student
            - DB_PASSWORD=infomdss
            - DB_PORT=5432
            # JSON data directories
            - KNRB_DATA_DIR=/app/data/knrb_data
            - TIME_TEAM_DATA_DIR=/app/data/time_team_data
            - PYTHONUNBUFFERED=1
        volumes:
            - ./json_importer:/app
            - ./data:/app/data
        depends_on:
            db_dashboard:
                condition: service_healthy
        profiles:
            - importer
        container_name: json_importer
        # Default command shows help
        # command: ["python", "json_importer.py", "--help"]

volumes:
    db_dashboard-data:
        driver: local
    mongo-data:
        driver: local

# Networks (optional - for better isolation)
networks:
    default:
        driver: bridge
